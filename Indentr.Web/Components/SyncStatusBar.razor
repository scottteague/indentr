@inject AppSession Session
@implements IAsyncDisposable

<div class="sync-bar">
    @if (Session.Sync is not null)
    {
        <span class="sync-time">
            Last sync: @(_lastSync == DateTimeOffset.MinValue ? "never" : _lastSync.ToLocalTime().ToString("HH:mm"))
        </span>
        <button class="sync-btn" @onclick="SyncNowAsync" disabled="@_syncing">
            @(_syncing ? "Syncingâ€¦" : "Sync Now")
        </button>
        @if (_syncMessage is not null)
        {
            <span class="sync-msg @(_syncError ? "sync-error" : "")">@_syncMessage</span>
        }
    }
    else
    {
        <span class="sync-time">Sync not configured</span>
    }
</div>

@code {
    private DateTimeOffset _lastSync;
    private bool   _syncing;
    private string? _syncMessage;
    private bool   _syncError;

    protected override async Task OnInitializedAsync()
    {
        if (Session.Sync is not null)
            _lastSync = await Session.Sync.GetLastSyncedAtAsync();
    }

    private async Task SyncNowAsync()
    {
        if (_syncing || Session.Sync is null) return;
        _syncing = true;
        _syncMessage = null;
        StateHasChanged();

        try
        {
            var result = await Session.Sync.SyncOnceAsync();
            _syncError = result.Status != SyncStatus.Success;
            _syncMessage = result.Status switch
            {
                SyncStatus.Success => "OK",
                SyncStatus.Offline => "Offline",
                _                  => result.Message ?? "Failed"
            };
            _lastSync = await Session.Sync.GetLastSyncedAtAsync();
        }
        finally
        {
            _syncing = false;
            StateHasChanged();
        }
    }

    public ValueTask DisposeAsync() => ValueTask.CompletedTask;
}
